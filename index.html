<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Family Recipe Book</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #fafafa;
}

header {
    padding: 1rem;
    background: #ffffff;
    border-bottom: 1px solid #ddd;
}

header h1 {
    margin: 0 0 0.5rem 0;
}

header input, header select {
    padding: 0.4rem;
    margin-right: 0.5rem;
}

.layout {
    display: grid;
    grid-template-columns: 260px 1fr;
    height: calc(100vh - 96px);
}

.sidebar {
    position: sticky;
    top: 0;
    overflow-y: auto;
    border-right: 1px solid #ddd;
    background: #fff;
    padding: 1rem;
}

.sidebar a {
    display: block;
    text-decoration: none;
    color: #333;
    font-size: 0.9rem;
    margin-bottom: 0.4rem;
}

.sidebar a:hover {
    text-decoration: underline;
}

main {
    overflow-y: auto;
    padding: 1.5rem;
}

.recipe {
    background: #fff;
    padding: 1rem;
    margin-bottom: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    min-height: 150px;
}

.recipe h2 {
    margin-top: 0;
}

.recipe img {
    max-width: 100%;
    border-radius: 6px;
    margin: 0.5rem 0 1rem 0;
}

.meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.meta-item {
    background: #f4f4f4;
    padding: 0.5rem;
    border-radius: 6px;
    font-size: 0.85rem;
}

.meta-label {
    display: block;
    font-size: 0.7rem;
    color: #666;
    font-weight: bold;
    text-transform: uppercase;
}

#backToTop {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 10px 14px;
    border: none;
    border-radius: 5px;
    background: #007acc;
    color: #fff;
    cursor: pointer;
    display: none;
}
</style>
</head>

<body>

<header>
    <h1>Family Recipe Book</h1>
    <input id="search" placeholder="Search recipes">
    <select id="filterCategory"><option value="">All categories</option></select>
    <select id="filterCuisine"><option value="">All cuisines</option></select>
</header>

<div class="layout">
    <nav class="sidebar" id="recipeIndex"></nav>
    <main id="recipes"></main>
</div>

<button id="backToTop">Top</button>
    
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
const recipesFolder = 'recipes/';
const recipesIndex = [
    'franse-preisoep-met-comte-borrelbrood.md',
    'snellduitse-kaassoep-met-prei.md',
    'witlof-krans.md',
    'ananas-tarte-tatin-met-kokijs.md'
];

const container = document.getElementById('recipes');
const indexEl = document.getElementById('recipeIndex');
const searchInput = document.getElementById('search');
const filterCategory = document.getElementById('filterCategory');
const filterCuisine = document.getElementById('filterCuisine');
const backBtn = document.getElementById('backToTop');

function parseFrontmatter(md) {
    const fm = md.match(/^---\s*([\s\S]*?)\s*---\s*/);
    if (!fm) return { meta: {}, body: md };

    const meta = {};
    fm[1].split(/\r?\n/).forEach(line => {
        const i = line.indexOf(':');
        if (i === -1) return;
        meta[line.slice(0, i).trim()] = line.slice(i + 1).trim();
    });

    return {
        meta,
        body: md.slice(fm[0].length).trim()
    };
}

function renderMeta(meta) {
    const fields = [
        ['persons', 'Persons'],
        ['prep_time', 'Prep'],
        ['cook_time', 'Cook'],
        ['category', 'Category'],
        ['cuisine', 'Cuisine'],
        ['source', 'Source']
    ];

    return `
        <div class="meta-grid">
            ${fields
                .filter(([k]) => meta[k] && meta[k] !== 'n/a')
                .map(([k, l]) => `
                    <div class="meta-item">
                        <span class="meta-label">${l}</span>
                        ${meta[k]}
                    </div>
                `).join('')}
        </div>
    `;
}

function slugify(text) {
    return text.toLowerCase().replace(/[^a-z0-9]+/g, '-');
}

function applyFilters() {
    const q = searchInput.value.toLowerCase();
    const c = filterCategory.value;
    const cu = filterCuisine.value;

    document.querySelectorAll('.recipe').forEach(r => {
        const text = r.dataset.search;
        const rc = r.dataset.category || '';
        const rcu = r.dataset.cuisine || '';
        const show =
            (!q || text.includes(q)) &&
            (!c || rc === c) &&
            (!cu || rcu === cu);
        r.style.display = show ? '' : 'none';
    });
}

window.addEventListener('scroll', () => {
    backBtn.style.display = window.scrollY > 300 ? 'block' : 'none';
});
backBtn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });

const observer = new IntersectionObserver(entries => {
    entries.forEach(e => {
        if (!e.isIntersecting || e.target.dataset.loaded) return;
        const { meta, body } = e.target._data;
        e.target.innerHTML = `
            <h2>${meta.title || 'Untitled'}</h2>
            ${renderMeta(meta)}
            <div class="content">${marked.parse(body)}</div>
        `;
        e.target.dataset.loaded = '1';
    });
}, { rootMargin: '200px' });

const cats = new Set();
const cuis = new Set();

recipesIndex.forEach(filename => {
    axios.get(recipesFolder + filename)
        .then(res => {
            const { meta, body } = parseFrontmatter(res.data);
            const id = slugify(meta.title || filename);

            if (meta.category) cats.add(meta.category);
            if (meta.cuisine) cuis.add(meta.cuisine);

            indexEl.insertAdjacentHTML(
                'beforeend',
                `<a href="#${id}">${meta.title || 'Untitled'}</a>`
            );

            const article = document.createElement('article');
            article.className = 'recipe';
            article.id = id;
            article.dataset.category = meta.category || '';
            article.dataset.cuisine = meta.cuisine || '';
            article.dataset.search = ((meta.title || '') + ' ' + body).toLowerCase();
            article._data = { meta, body };
            article.innerHTML = '<em>Loading...</em>';

            container.appendChild(article);
            observer.observe(article);
        })
        .catch(err => console.error('Failed to load', filename, err));
});

setTimeout(() => {
    [...cats].forEach(c =>
        filterCategory.insertAdjacentHTML(
            'beforeend',
            `<option value="${c}">${c}</option>`
        )
    );
    [...cuis].forEach(c =>
        filterCuisine.insertAdjacentHTML(
            'beforeend',
            `<option value="${c}">${c}</option>`
        )
    );
}, 500);

searchInput.oninput = applyFilters;
filterCategory.onchange = applyFilters;
filterCuisine.onchange = applyFilters;
</script>


</body>
</html>

